import React, { useState } from 'react';
import { RotateCcw, ArrowRight, GripVertical } from 'lucide-react';

const ValuesExercise = () => {
  const allValues = [
    'אדיבות', 'אהבה', 'אהבת המולדת', 'אומץ', 'אופטימיות', 'אושר', 'אותנטיות', 'אחדות', 'אחריות', 'איזון', 'אכפתיות', 'אמון', 'אמונה',
    'אמפתיה', 'אמת', 'אנושיות', 'אסרטיביות', 'אצילות', 'בהירות', 'בחירה', 'ביטחון', 'ביטוי עצמי', 'בין אדם לחברו', 'בריאות',
    'גאווה', 'גבורה', 'גמישות', 'דוגמא אישית', 'הבנה', 'הגיון', 'הגינות', 'הגנה', 'הגשמה', 'הדדיות', 'הובלה', 'הומור', 'הוקרת תודה',
    'הזדהות', 'הישגיות', 'החלטיות', 'הסתגלות', 'הסתפקות במועט', 'הערכה', 'הצלחה', 'הקשבה', 'הרמוניה', 'השפעה', 'התלהבות', 'התמדה',
    'חברות', 'חדשנות', 'חופש בחירה', 'חיים', 'חכמת חיים', 'חמלה', 'חריצות', 'ידע', 'יוזמה', 'יושר פנימי', 'יושרה', 'ייחודיות',
    'יסודיות', 'יעילות', 'יציבות', 'יצירתיות', 'כבוד', 'כבוד המשפחה', 'כיבוד האדם', 'כנות', 'למידה', 'לקיחת סיכונים',
    'מחויבות', 'מחילה', 'מיקוד במטרה', 'מנהיגות', 'מסורת', 'מסירות', 'מעורבות', 'מעשיות', 'מצוינות', 'מקוריות', 'מקצועיות',
    'משמעת עצמית', 'משפחה', 'נאמנות', 'נדיבות', 'נוחות', 'נחישות', 'ניקיון', 'נתינה', 'סבלנות', 'סדר', 'סובלנות', 'ספונטניות',
    'עבודת צוות', 'עזרה לזולת', 'ענווה', 'עצמאות', 'עקביות', 'פשטות', 'פתיחות', 'צדק', 'צמיחה', 'צניעות', 'קבלה עצמית',
    'רוגע', 'רוחניות', 'רעות', 'שאפתנות', 'שוויון', 'שותפות', 'שיתוף פעולה', 'שמחת חיים', 'תמימות', 'תעוזה', 'תקווה', 'תקשורת'
  ];

  const [stage, setStage] = useState(0);
  const [selectedValues, setSelectedValues] = useState([]);
  const [rankedValues, setRankedValues] = useState([]);
  const [draggedItem, setDraggedItem] = useState(null);

  const handleValueClick = (value) => {
    if (selectedValues.includes(value)) {
      setSelectedValues(selectedValues.filter(v => v !== value));
    } else if (selectedValues.length < 5) {
      setSelectedValues([...selectedValues, value]);
    }
  };

  const handleReset = () => {
    setSelectedValues([]);
  };

  const moveToStage2 = () => {
    setRankedValues(selectedValues.map((value, index) => ({ value, rank: index + 1 })));
    setStage(2);
  };

  const handleDragStart = (e, index) => {
    setDraggedItem(index);
    e.dataTransfer.effectAllowed = 'move';
  };

  const handleDragOver = (e, index) => {
    e.preventDefault();
    if (draggedItem === null || draggedItem === index) return;

    const newRanked = [...rankedValues];
    const draggedValue = newRanked[draggedItem];
    newRanked.splice(draggedItem, 1);
    newRanked.splice(index, 0, draggedValue);
    
    setDraggedItem(index);
    setRankedValues(newRanked.map((item, idx) => ({ ...item, rank: idx + 1 })));
  };

  const handleDragEnd = () => {
    setDraggedItem(null);
  };

  const backToStage1 = () => {
    setStage(1);
  };

  const canContinue = selectedValues.length === 5;

  return (
    <div className="bg-gradient-to-br from-gray-50 to-slate-100 overflow-hidden" style={{ width: '1200px', height: '675px', fontFamily: 'Heebo, sans-serif' }} dir="rtl">
      <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
      
      <div className="h-full flex flex-col">
        {/* Compact Header */}
        <div className="bg-white border-b border-gray-200 py-2 px-4 text-center shadow-sm">
          <h1 className="text-xl font-semibold text-gray-800">ערכים אישיים - תרגיל ברור ערכים אישיים</h1>
        </div>

        {/* Content Area */}
        <div className="flex-1 overflow-hidden">
          {/* Instructions Screen */}
          {stage === 0 && (
            <div className="h-full flex items-center justify-center p-8">
              <div className="bg-white rounded-3xl shadow-lg p-12 max-w-4xl border border-gray-200">
                <h3 className="text-3xl font-semibold text-gray-800 mb-8 text-center">ברוכים הבאים לתרגיל ברור ערכים</h3>
                
                <div className="space-y-6 mb-8">
                  <div className="bg-blue-50 rounded-2xl p-6 border border-blue-100">
                    <h4 className="text-xl font-semibold text-gray-800 mb-3">שלב 1 - בחירת ערכים</h4>
                    <p className="text-gray-700 mb-2 leading-relaxed">לפניכם רשימה של ערכים אישיים</p>
                    <p className="text-gray-700 mb-2 leading-relaxed">יש לבחור מתוכם את <strong>חמשת הערכים המרכזיים</strong> החשובים ביותר בחיים האישיים והמקצועיים</p>
                    <p className="text-gray-600 text-sm">💡 לחיצה על ערך תבחר אותו - ניתן לבחור עד 5 ערכים</p>
                  </div>

                  <div className="bg-purple-50 rounded-2xl p-6 border border-purple-100">
                    <h4 className="text-xl font-semibold text-gray-800 mb-3">שלב 2 - דירוג הערכים</h4>
                    <p className="text-gray-700 mb-2 leading-relaxed">לאחר הבחירה, יש לדרג את הערכים שנבחרו</p>
                    <p className="text-gray-700 leading-relaxed">יש לסדר אותם לפי סדר החשיבות ומידת המקום שהם תופסים בחיים</p>
                    <p className="text-gray-600 text-sm mt-2">💡 ניתן לגרור את הערכים כדי לסדר אותם</p>
                  </div>
                </div>

                <button
                  onClick={() => setStage(1)}
                  className="w-full bg-gray-800 hover:bg-gray-900 text-white font-medium py-4 px-8 rounded-full transition-all text-lg flex items-center justify-center gap-3 shadow-md hover:shadow-lg"
                >
                  התחל את התרגיל
                  <ArrowRight size={22} />
                </button>
              </div>
            </div>
          )}

          {/* Stage 1 - Selection */}
          {stage === 1 && (
            <div className="h-full flex flex-row p-6 gap-6">
              {/* Side panel - RIGHT SIDE */}
              <div className="w-72 flex flex-col flex-shrink-0">
                <div className="bg-white rounded-2xl p-4 shadow-sm border border-gray-200 mb-4">
                  <div className="text-lg font-semibold text-gray-800 mb-2">
                    שלב 1: בחירת ערכים
                  </div>
                  <div className="flex items-center justify-between gap-2">
                    <div className="text-sm font-medium text-gray-700 bg-blue-50 px-3 py-1.5 rounded-full border border-blue-200">
                      נבחרו: {selectedValues.length}/5
                    </div>
                    {selectedValues.length > 0 && (
                      <button
                        onClick={handleReset}
                        className="flex items-center gap-1 px-3 py-1.5 bg-white hover:bg-gray-50 text-gray-700 rounded-full transition-all border border-gray-200 shadow-sm text-xs"
                      >
                        <RotateCcw size={14} />
                        איפוס
                      </button>
                    )}
                  </div>
                </div>

                <div className="flex-1 overflow-hidden">
                  {canContinue ? (
                    <div className="bg-gradient-to-br from-amber-50 to-yellow-50 border-2 border-amber-300 rounded-2xl p-4 shadow-sm h-full flex flex-col">
                      <h4 className="text-base font-semibold text-gray-800 mb-3 text-center">
                        ✨ הערכים שנבחרו
                      </h4>
                      <div className="space-y-2 mb-3 flex-1 overflow-y-auto">
                        {selectedValues.map((value, idx) => (
                          <div key={value} className="flex items-center gap-2 bg-white px-3 py-2 rounded-full border border-amber-200 shadow-sm">
                            <div className="w-5 h-5 rounded-full bg-gray-800 text-white text-xs flex items-center justify-center font-semibold flex-shrink-0">
                              {idx + 1}
                            </div>
                            <span className="text-xs text-gray-800 font-medium truncate">{value}</span>
                          </div>
                        ))}
                      </div>
                      <p className="text-xs text-gray-700 mb-3 leading-relaxed text-center">
                        האם ערכים אלו מהווים את העקרונות שלפיהם פועלים ביום יום?
                      </p>
                      <button
                        onClick={moveToStage2}
                        className="w-full bg-gray-800 hover:bg-gray-900 text-white font-medium py-2 px-4 rounded-full transition-all shadow-md hover:shadow-lg text-sm"
                      >
                        המשך לשלב הבא
                      </button>
                    </div>
                  ) : (
                    <div className="bg-blue-50 border-2 border-blue-200 rounded-2xl p-5 shadow-sm">
                      <div className="text-center mb-3">
                        <div className="text-3xl mb-2">👆</div>
                        <h4 className="text-sm font-semibold text-gray-800 mb-2">
                          כיצד לבחור?
                        </h4>
                      </div>
                      <p className="text-xs text-gray-700 leading-relaxed text-center">
                        יש ללחוץ על הערכים החשובים ביותר. לאחר בחירת 5 ערכים, ניתן להמשיך לשלב הדירוג.
                      </p>
                    </div>
                  )}
                </div>
              </div>

              {/* Main content area with values - LEFT SIDE */}
              <div className="flex-1 flex flex-col min-w-0 overflow-hidden">
                <div className="h-full overflow-hidden">
                  <div className="grid grid-cols-11 gap-2 h-full content-start">
                    {allValues.map((value, index) => {
                      const isSelected = selectedValues.includes(value);
                      const shouldShow = selectedValues.length < 5 || isSelected;
                      
                      return (
                        <button
                          key={index}
                          onClick={() => handleValueClick(value)}
                          style={{ height: '38px', minHeight: '38px', maxHeight: '38px' }}
                          className={`
                            px-3 rounded-full font-normal transition-all duration-200 text-xs flex items-center justify-center leading-tight
                            ${shouldShow ? 'opacity-100' : 'opacity-20 pointer-events-none'}
                            ${isSelected 
                              ? 'bg-gray-800 text-white shadow-md border-2 border-gray-800 font-medium' 
                              : 'bg-white text-gray-700 border-2 border-gray-300 hover:border-gray-400 hover:shadow-sm'
                            }
                          `}
                        >
                          {value}
                        </button>
                      );
                    })}
                  </div>
                </div>
              </div>
            </div>
          )}

          {/* Stage 2 - Ranking */}
          {stage === 2 && (
            <div className="h-full flex flex-row p-6 gap-6">
              {/* Side panel - RIGHT SIDE */}
              <div className="w-72 flex flex-col flex-shrink-0">
                <div className="bg-white rounded-2xl p-4 shadow-sm border border-gray-200 mb-4">
                  <div className="text-lg font-semibold text-gray-800 mb-2">
                    שלב 2: דירוג הערכים
                  </div>
                  <p className="text-xs text-gray-600">
                    יש לגרור את הערכים כדי לסדר לפי חשיבות
                  </p>
                </div>

                <div className="flex-1 bg-gradient-to-br from-green-50 to-emerald-50 border-2 border-green-300 rounded-2xl p-5 shadow-sm overflow-hidden flex flex-col">
                  <h4 className="text-base font-semibold text-gray-800 mb-4 text-center">
                    🏆 הסדר שלך
                  </h4>
                  <div className="flex-1 overflow-y-auto mb-4">
                    <ol className="space-y-2 text-gray-700">
                      {rankedValues.map((item) => (
                        <li key={item.value} className="flex items-center gap-3 bg-white px-3 py-2 rounded-full border border-green-200 shadow-sm">
                          <div className="w-6 h-6 rounded-full bg-gray-800 text-white text-xs flex items-center justify-center font-semibold flex-shrink-0">
                            {item.rank}
                          </div>
                          <span className="text-sm font-medium text-gray-800 truncate">{item.value}</span>
                        </li>
                      ))}
                    </ol>
                  </div>
                  <button
                    onClick={backToStage1}
                    className="w-full bg-white hover:bg-gray-50 text-gray-800 font-medium py-2 px-4 rounded-full transition-all border-2 border-gray-300 shadow-sm text-sm"
                  >
                    חזרה לשלב 1
                  </button>
                </div>
              </div>

              {/* Main content area with draggable values - LEFT SIDE */}
              <div className="flex-1 flex flex-col min-w-0 overflow-hidden">
                <div className="flex-1 overflow-y-auto">
                  <div className="space-y-3">
                    {rankedValues.map((item, index) => (
                      <div
                        key={item.value}
                        draggable
                        onDragStart={(e) => handleDragStart(e, index)}
                        onDragOver={(e) => handleDragOver(e, index)}
                        onDragEnd={handleDragEnd}
                        className={`
                          bg-white rounded-2xl shadow-sm p-4 flex items-center gap-4 cursor-move
                          hover:shadow-lg hover:scale-[1.02] transition-all border-2 border-gray-200
                          ${draggedItem === index ? 'opacity-50 scale-95' : 'opacity-100'}
                        `}
                      >
                        <div className="flex items-center gap-3 text-gray-400">
                          <GripVertical size={24} className="flex-shrink-0" />
                        </div>
                        <div className="w-12 h-12 rounded-full bg-gray-800 text-white flex items-center justify-center font-bold text-lg flex-shrink-0 shadow-md">
                          {item.rank}
                        </div>
                        <div className="flex-1 text-xl font-medium text-gray-800">
                          {item.value}
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              </div>
            </div>
          )}
        </div>
      </div>
    </div>
  );
};

export default ValuesExercise;

import React, { useState } from 'react';
import { RotateCcw, ArrowRight, GripVertical } from 'lucide-react';

const ValuesExercise = () => {
  const allValues = [
    '××“×™×‘×•×ª', '××”×‘×”', '××”×‘×ª ×”××•×œ×“×ª', '××•××¥', '××•×¤×˜×™××™×•×ª', '××•×©×¨', '××•×ª× ×˜×™×•×ª', '××—×“×•×ª', '××—×¨×™×•×ª', '××™×–×•×Ÿ', '××›×¤×ª×™×•×ª', '×××•×Ÿ', '×××•× ×”',
    '×××¤×ª×™×”', '×××ª', '×× ×•×©×™×•×ª', '××¡×¨×˜×™×‘×™×•×ª', '××¦×™×œ×•×ª', '×‘×”×™×¨×•×ª', '×‘×—×™×¨×”', '×‘×™×˜×—×•×Ÿ', '×‘×™×˜×•×™ ×¢×¦××™', '×‘×™×Ÿ ××“× ×œ×—×‘×¨×•', '×‘×¨×™××•×ª',
    '×’××•×•×”', '×’×‘×•×¨×”', '×’××™×©×•×ª', '×“×•×’×× ××™×©×™×ª', '×”×‘× ×”', '×”×’×™×•×Ÿ', '×”×’×™× ×•×ª', '×”×’× ×”', '×”×’×©××”', '×”×“×“×™×•×ª', '×”×•×‘×œ×”', '×”×•××•×¨', '×”×•×§×¨×ª ×ª×•×“×”',
    '×”×–×“×”×•×ª', '×”×™×©×’×™×•×ª', '×”×—×œ×˜×™×•×ª', '×”×¡×ª×’×œ×•×ª', '×”×¡×ª×¤×§×•×ª ×‘××•×¢×˜', '×”×¢×¨×›×”', '×”×¦×œ×—×”', '×”×§×©×‘×”', '×”×¨××•× ×™×”', '×”×©×¤×¢×”', '×”×ª×œ×”×‘×•×ª', '×”×ª××“×”',
    '×—×‘×¨×•×ª', '×—×“×©× ×•×ª', '×—×•×¤×© ×‘×—×™×¨×”', '×—×™×™×', '×—×›××ª ×—×™×™×', '×—××œ×”', '×—×¨×™×¦×•×ª', '×™×“×¢', '×™×•×–××”', '×™×•×©×¨ ×¤× ×™××™', '×™×•×©×¨×”', '×™×™×—×•×“×™×•×ª',
    '×™×¡×•×“×™×•×ª', '×™×¢×™×œ×•×ª', '×™×¦×™×‘×•×ª', '×™×¦×™×¨×ª×™×•×ª', '×›×‘×•×“', '×›×‘×•×“ ×”××©×¤×—×”', '×›×™×‘×•×“ ×”××“×', '×›× ×•×ª', '×œ××™×“×”', '×œ×§×™×—×ª ×¡×™×›×•× ×™×',
    '××—×•×™×‘×•×ª', '××—×™×œ×”', '××™×§×•×“ ×‘××˜×¨×”', '×× ×”×™×’×•×ª', '××¡×•×¨×ª', '××¡×™×¨×•×ª', '××¢×•×¨×‘×•×ª', '××¢×©×™×•×ª', '××¦×•×™× ×•×ª', '××§×•×¨×™×•×ª', '××§×¦×•×¢×™×•×ª',
    '××©××¢×ª ×¢×¦××™×ª', '××©×¤×—×”', '× ××× ×•×ª', '× ×“×™×‘×•×ª', '× ×•×—×•×ª', '× ×—×™×©×•×ª', '× ×™×§×™×•×Ÿ', '× ×ª×™× ×”', '×¡×‘×œ× ×•×ª', '×¡×“×¨', '×¡×•×‘×œ× ×•×ª', '×¡×¤×•× ×˜× ×™×•×ª',
    '×¢×‘×•×“×ª ×¦×•×•×ª', '×¢×–×¨×” ×œ×–×•×œ×ª', '×¢× ×•×•×”', '×¢×¦×××•×ª', '×¢×§×‘×™×•×ª', '×¤×©×˜×•×ª', '×¤×ª×™×—×•×ª', '×¦×“×§', '×¦××™×—×”', '×¦× ×™×¢×•×ª', '×§×‘×œ×” ×¢×¦××™×ª',
    '×¨×•×’×¢', '×¨×•×—× ×™×•×ª', '×¨×¢×•×ª', '×©××¤×ª× ×•×ª', '×©×•×•×™×•×Ÿ', '×©×•×ª×¤×•×ª', '×©×™×ª×•×£ ×¤×¢×•×œ×”', '×©××—×ª ×—×™×™×', '×ª××™××•×ª', '×ª×¢×•×–×”', '×ª×§×•×•×”', '×ª×§×©×•×¨×ª'
  ];

  const [stage, setStage] = useState(1);
  const [selectedValues, setSelectedValues] = useState([]);
  const [rankedValues, setRankedValues] = useState([]);
  const [draggedItem, setDraggedItem] = useState(null);

  const handleValueClick = (value) => {
    if (selectedValues.includes(value)) {
      setSelectedValues(selectedValues.filter(v => v !== value));
    } else if (selectedValues.length < 5) {
      setSelectedValues([...selectedValues, value]);
    }
  };

  const handleReset = () => {
    setSelectedValues([]);
  };

  const moveToStage2 = () => {
    setRankedValues(selectedValues.map((value, index) => ({ value, rank: index + 1 })));
    setStage(2);
  };

  const handleDragStart = (e, index) => {
    setDraggedItem(index);
    e.dataTransfer.effectAllowed = 'move';
  };

  const handleDragOver = (e, index) => {
    e.preventDefault();
    if (draggedItem === null || draggedItem === index) return;

    const newRanked = [...rankedValues];
    const draggedValue = newRanked[draggedItem];
    newRanked.splice(draggedItem, 1);
    newRanked.splice(index, 0, draggedValue);
    
    setDraggedItem(index);
    setRankedValues(newRanked.map((item, idx) => ({ ...item, rank: idx + 1 })));
  };

  const handleDragEnd = () => {
    setDraggedItem(null);
  };

  const backToStage1 = () => {
    setStage(1);
  };

  const canContinue = selectedValues.length === 5;

  return (
    <div className="bg-gradient-to-br from-gray-50 to-slate-100 overflow-hidden" style={{ width: '1090px', height: '535px', fontFamily: 'Heebo, sans-serif' }} dir="rtl">
      <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
      
      <div className="h-full flex flex-col">
        {/* Compact Header */}
        <div className="bg-white border-b border-gray-200 py-1 px-3 text-center shadow-sm">
          <h1 className="text-base font-semibold text-gray-800">×¢×¨×›×™× ××™×©×™×™× - ×ª×¨×’×™×œ ×‘×¨×•×¨ ×¢×¨×›×™× ××™×©×™×™×</h1>
        </div>

        {/* Content Area */}
        <div className="flex-1 overflow-hidden">
          {/* Stage 1 - Selection */}
          {stage === 1 && (
            <div className="h-full flex flex-row p-4 gap-4">
              {/* Side panel - RIGHT SIDE */}
              <div className="w-52 flex flex-col flex-shrink-0">
                <div className="bg-white rounded-2xl p-3 shadow-sm border border-gray-200 mb-3">
                  <div className="text-base font-semibold text-gray-800 mb-1.5">
                    ×©×œ×‘ 1: ×‘×—×™×¨×ª ×¢×¨×›×™×
                  </div>
                  <div className="flex items-center justify-between gap-2">
                    <div className="text-xs font-medium text-gray-700 bg-blue-50 px-2 py-1 rounded-full border border-blue-200">
                      × ×‘×—×¨×•: {selectedValues.length}/5
                    </div>
                    {selectedValues.length > 0 && (
                      <button
                        onClick={handleReset}
                        className="flex items-center gap-1 px-2 py-1 bg-white hover:bg-gray-50 text-gray-700 rounded-full transition-all border border-gray-200 shadow-sm text-xs"
                      >
                        <RotateCcw size={12} />
                        ××™×¤×•×¡
                      </button>
                    )}
                  </div>
                </div>

                <div className="flex-1 overflow-hidden">
                  {canContinue ? (
                    <div className="bg-gradient-to-br from-amber-50 to-yellow-50 border-2 border-amber-300 rounded-2xl p-3 shadow-sm h-full flex flex-col">
                      <h4 className="text-sm font-semibold text-gray-800 mb-2 text-center">
                        âœ¨ ×”×¢×¨×›×™× ×©× ×‘×—×¨×•
                      </h4>
                      <div className="space-y-1.5 mb-2 flex-1 overflow-y-auto">
                        {selectedValues.map((value, idx) => (
                          <div key={value} className="flex items-center gap-2 bg-white px-2 py-1.5 rounded-full border border-amber-200 shadow-sm">
                            <div className="w-4 h-4 rounded-full bg-gray-800 text-white text-xs flex items-center justify-center font-semibold flex-shrink-0" style={{ fontSize: '10px' }}>
                              {idx + 1}
                            </div>
                            <span className="text-xs text-gray-800 font-medium truncate">{value}</span>
                          </div>
                        ))}
                      </div>
                      <p className="text-xs text-gray-700 mb-2 leading-relaxed text-center">
                        ×”×× ×¢×¨×›×™× ××œ×• ××”×•×•×™× ××ª ×”×¢×§×¨×•× ×•×ª ×©×œ×¤×™×”× ×¤×•×¢×œ×™× ×‘×™×•× ×™×•×?
                      </p>
                      <button
                        onClick={moveToStage2}
                        className="w-full bg-gray-800 hover:bg-gray-900 text-white font-medium py-1.5 px-3 rounded-full transition-all shadow-md hover:shadow-lg text-xs"
                      >
                        ×”××©×š ×œ×©×œ×‘ ×”×‘×
                      </button>
                    </div>
                  ) : (
                    <div className="bg-blue-50 border-2 border-blue-200 rounded-2xl p-4 shadow-sm">
                      <div className="text-center mb-2">
                        <div className="text-2xl mb-2">ğŸ‘†</div>
                        <h4 className="text-xs font-semibold text-gray-800 mb-2">
                          ×›×™×¦×“ ×œ×‘×—×•×¨?
                        </h4>
                      </div>
                      <p className="text-xs text-gray-700 leading-relaxed text-center">
                        ×™×© ×œ×œ×—×•×¥ ×¢×œ ×”×¢×¨×›×™× ×”×—×©×•×‘×™× ×‘×™×•×ª×¨. ×œ××—×¨ ×‘×—×™×¨×ª 5 ×¢×¨×›×™×, × ×™×ª×Ÿ ×œ×”××©×™×š ×œ×©×œ×‘ ×”×“×™×¨×•×’.
                      </p>
                    </div>
                  )}
                </div>
              </div>

              {/* Main content area with values - LEFT SIDE */}
              <div className="flex-1 flex flex-col min-w-0 overflow-hidden">
                <div className="h-full overflow-hidden">
                  <div className="grid grid-cols-11 gap-1.5 h-full content-start">
                    {allValues.map((value, index) => {
                      const isSelected = selectedValues.includes(value);
                      const shouldShow = selectedValues.length < 5 || isSelected;
                      
                      return (
                        <button
                          key={index}
                          onClick={() => handleValueClick(value)}
                          style={{ height: '34px', minHeight: '34px', maxHeight: '34px' }}
                          className={`
                            px-2 rounded-full font-normal transition-all duration-200 text-xs flex items-center justify-center leading-tight
                            ${shouldShow ? 'opacity-100' : 'opacity-20 pointer-events-none'}
                            ${isSelected 
                              ? 'bg-gray-800 text-white shadow-md border-2 border-gray-800 font-medium' 
                              : 'bg-white text-gray-700 border-2 border-gray-300 hover:border-gray-400 hover:shadow-sm'
                            }
                          `}
                        >
                          {value}
                        </button>
                      );
                    })}
                  </div>
                </div>
              </div>
            </div>
          )}

          {/* Stage 2 - Ranking */}
          {stage === 2 && (
            <div className="h-full flex flex-row p-4 gap-4">
              {/* Side panel - RIGHT SIDE */}
              <div className="w-52 flex flex-col flex-shrink-0">
                <div className="bg-white rounded-2xl p-3 shadow-sm border border-gray-200 mb-3">
                  <div className="text-base font-semibold text-gray-800 mb-1">
                    ×©×œ×‘ 2: ×“×™×¨×•×’ ×”×¢×¨×›×™×
                  </div>
                  <p className="text-xs text-gray-600">
                    ×™×© ×œ×’×¨×•×¨ ××ª ×”×¢×¨×›×™× ×›×“×™ ×œ×¡×“×¨ ×œ×¤×™ ×—×©×™×‘×•×ª
                  </p>
                </div>

                <div className="flex-1 bg-gradient-to-br from-green-50 to-emerald-50 border-2 border-green-300 rounded-2xl p-3 shadow-sm overflow-hidden flex flex-col">
                  <h4 className="text-sm font-semibold text-gray-800 mb-2 text-center">
                    ğŸ† ×”×¡×“×¨ ×©×œ×š
                  </h4>
                  <div className="flex-1 overflow-y-auto mb-3">
                    <ol className="space-y-1.5 text-gray-700">
                      {rankedValues.map((item) => (
                        <li key={item.value} className="flex items-center gap-2 bg-white px-2 py-1.5 rounded-full border border-green-200 shadow-sm">
                          <div className="w-5 h-5 rounded-full bg-gray-800 text-white text-xs flex items-center justify-center font-semibold flex-shrink-0">
                            {item.rank}
                          </div>
                          <span className="text-xs font-medium text-gray-800 truncate">{item.value}</span>
                        </li>
                      ))}
                    </ol>
                  </div>
                  <button
                    onClick={backToStage1}
                    className="w-full bg-white hover:bg-gray-50 text-gray-800 font-medium py-1.5 px-3 rounded-full transition-all border-2 border-gray-300 shadow-sm text-xs"
                  >
                    ×—×–×¨×” ×œ×©×œ×‘ 1
                  </button>
                </div>
              </div>

              {/* Main content area with draggable values - LEFT SIDE */}
              <div className="flex-1 flex flex-col min-w-0 overflow-hidden">
                <div className="flex-1 overflow-y-auto">
                  <div className="space-y-2.5">
                    {rankedValues.map((item, index) => (
                      <div
                        key={item.value}
                        draggable
                        onDragStart={(e) => handleDragStart(e, index)}
                        onDragOver={(e) => handleDragOver(e, index)}
                        onDragEnd={handleDragEnd}
                        className={`
                          bg-white rounded-2xl shadow-sm p-3.5 flex items-center gap-3 cursor-move
                          hover:shadow-lg hover:scale-[1.01] transition-all border-2 border-gray-200
                          ${draggedItem === index ? 'opacity-50 scale-95' : 'opacity-100'}
                        `}
                      >
                        <div className="flex items-center gap-2 text-gray-400">
                          <GripVertical size={22} className="flex-shrink-0" />
                        </div>
                        <div className="w-11 h-11 rounded-full bg-gray-800 text-white flex items-center justify-center font-bold text-lg flex-shrink-0 shadow-md">
                          {item.rank}
                        </div>
                        <div className="flex-1 text-lg font-medium text-gray-800">
                          {item.value}
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              </div>
            </div>
          )}
        </div>
      </div>
    </div>
  );
};

export default ValuesExercise;
